import React from 'react'
import Chatkit from '@pusher/chatkit'
import MessageList from '../../componentes/MessageList/MessageList'
import SendMessageForm from '../../componentes/SendMessageForm/SendMessageForm'

class ChatScreen extends React.Component{
   
    constructor(props){
        super(props)
        this.state = {
            messages : [],
            currentRoom: {},
            currentUser:{}
        }
        this.sendMessage = this.sendMessage.bind(this) 
    }
    
    componentDiMount(){
        const chatManager = new Chatkit.ChatManager({
            instanceLocator: 'v1:us1:20b55e86-abcf-463c-87f8-52d96d352c08',
            userId: this.props.currentUsername,
            tokenProvider : new Chatkit.TokenProvider({
                url: 'http://localhost:3001/authenticate'
            }),
        })

        chatManager
        .connect()        
        .then(currentUser => {
            this.setState({currentUser})
            return currentUser.subscribeToRoom({
                roomId:'19389842',
                messageLimit: 100,
                books:{
                    onNewMesage:message => {
                        this.setState({
                            messages:[...this.state.messages, message],
                        })
                    },
                },
            })
        })
        .then(currentRoom =>{
            this.setState({currentRoom})
        })
        .catch(error=> console.error(error))
    }
       render(){
        return(
            <div>
                <h1>Chat</h1>
                <p>Ol√°, {this.props.currentUsername}</p>
                <MessageList messages = {this.state.messages}/>
                <SendMessageForm onSubmit = {this.sendMessage}/>            
            </div>
        )
    }
}

export default ChatScreen